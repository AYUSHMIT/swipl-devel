#!/bin/sh
#
# Author: Jan Wielemaker (jan@swi.psy.uva.nl)
# Copyright 1994, University of Amsterdam
#
# Copies library files, binaries and other related files to public area
# and then runs ./install to create the xpce-$version executable.
#
# usage:
#	
#   ./install-bins		equivalent to ./install-bins /usr/local
#   ./install-bins area
#	Creates <area>/lib/xpce-$version to hold the libraries
#	and     <area>/bin/xpce-$version for the executable
#	and	<area>/bin/xpce-client for the socket connection program
#

# setup variables

base=/usr/local
if [ "$1" != "" ]; then base=$1; fi

version=`cat VERSION`
libdir=$base/lib/xpce-$version
bin=$base/bin/xpce-$version
client=$base/bin/xpce-client
install=install

# link SWI-Prolog into this area

for d in library boot include; do
    if [ ! -d pl/$d ]; then (cd pl; ln -s ../../pl/$d .); fi
done

# collect necessary files and directories

echo ""
echo "Installing xpce-$version libraries in $libdir"
echo ""

filesa="bin/xpce.base bin/xpce-client src/XPCE.a pl/src/pl-crt0.o"
filesb="INSTALL install README* INFO include src/load.pl src/xpce.pl"
filesc="C++/demo/Makefile C++/demo/README C++/demo/*.C C++/demo/*.bm"
filesd="STAMP VERSION ChangeLog licence/licence.tex"
filese="src/unx/client.c src/h/interface.h"
filesf="Pce bitmaps postscript man/reference"
filesg="prolog/boot prolog/lib pl/library pl/boot pl/include"
allfiles="$filesa $filesb $filesc $filesd $filese $filesf $filesg"

# Remove possible existing directory

if [ -d $libdir ]; then
    echo -n "Installation directory $libdir already exists.  Remove (y/n)? "
    read answer
    if [ "$answer" = "y" ]; then
	echo -n "Running rm -rf $libdir ... "
        rm -rf $libdir;
	echo "done."
    fi
fi

# Create new one 

if [ ! -d $libdir ]; then mkdir $libdir; fi

echo -n "Copying files to $libdir ... "
tar cfh - $allfiles | (cd $libdir; tar xf -)
echo "done."
echo -n "Cleaning $libdir ... "
(cd $libdir; rm -rf `find . \( -name CVS -o -name '*~' \) -print`)
echo "done."
if [ `whoami` = "root" ]; then
    echo -n "Changing owner to root.bin in $libdir ... "
    (cd $libdir; chown -R root.bin .)
    echo "done."
fi
echo -n "Fixing permissions ... "
echo -n "(files: 644) ... "
(cd $libdir; find . -type f -exec chmod 644 {} \;)
echo -n "(dirs: 755) ... "
(cd $libdir; find . -type d -exec chmod 755 {} \;)
echo -n "(binaries: 755) ... "
(cd $libdir/bin; find . -type f -exec chmod 755 {} \;)
chmod 755 $libdir/install
echo "done."

echo "Starting $libdir/install $bin"
(cd $libdir; ./install $bin)
if [ ! -x $client ]; then
    echo -n "Installing $client ... "
    $install bin/xpce-client $base/bin
    echo "done."
fi
