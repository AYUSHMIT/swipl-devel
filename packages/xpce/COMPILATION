				Compiling XPCE
				Jan Wielemaker
				   01/11/94

Updated for xpce-4.8.13 at Tue Sep  5 18:09:18 1995

Prerequisites:
==============

* A source LICENCE agreement!

* A supported Unix machine with a supported operating system.

* A recent copy of the GNU-Project C-compiler gcc.  Versions known to
  work are gcc-2.x.y, where 3<=x<=5 and y>x or gcc 2.6.3. Some others
  are fine too. The C++ interface is written in C++ and therefore you
  need to have g++ installed too to include this (configure is clever
  enough to omit the C++ interface if you have g++ not installed).

* A recent copy of the GNU-Project `make' utility.  Versions tested are
  3.62 and 3.71 and 3.74.  Most versions will do.  The native make
  utility provided with many operating systems won't.

* If you want to link to SWI-Prolog to create XPCE/SWI-Prolog, SWI-Prolog
  version 2.1.5 or later must be installed (using make install) as one
  of `pl', `swipl' or `swi-prolog'. The automatic configuration script
  will call SWI-Prolog to determine system parameters of it.


Preparation:
============

You can either compile  in  the  source   directory,  or  in  a separate
directory. We advice the latter, as  it   makes  it more easy to compile
multiple versions from the same sources   (for  example both the runtime
and the development version or versions for different hardware).  In the
first case simply

	cd src

in the latter case, invent a nice directory name and do (for example):

	mkdir sunos
	cd sunos

* Run configure.  The example works always, but of course you can simply
  use `sh configure' if you compile in the source directory.

	% sh ../src/configure

  If you do not want to install XPCE with SWI-Prolog, you should do

	% sh ../src/configure --without-pl

  configure creates config.h, describing many aspects of your compiler
  and C-libraries.

  When configuring for linking to SWI-Prolog, configure will also
  determine which of the two linking schemas is used:

     * Shared library based

     If it detects the SWI-Prolog feature `open_shared_object' it
     assumes SWI-Prolog can dynamically load shared object files
     (extension .so on sysvr4 Unix systems) and will try to make
     the target lib/xpce4pl.<so>, where <so> is the extension used for
     shared objects on this Unix platform.

     In addition, it will target a couple of `.qlf' (SWI-Prolog
     Quick Load Files) that allow for quick dynamic loading of
     xpce in the plain SWI-Prolog executable.

     The target for pl/src/Makefile is `soall'

     * Statically linked version
     
     If SWI-Prolog cannot load shared objects, configure will set
     up the target bin/xpce, a statically linked SWI-Prolog
     version that includes XPCE.  NOTE: `statically linked' here
     is the opposite of dynamic linking of shared objects in the
     running executable.  It does *not* necessarily mean using
     static C libraries.

     It will also create the target bin/xpce.qlf, a Prolog boot
     image containing the normal Prolog boot files as well as the
     XPCE kernel files.

     The target for pl/src/Makefile is `nosoall'

  Note that, unlike previous versions, XPCE/SWI-Prolog is no longer
  created using SWI-Prolog's save_program/1 predicate.  The current
  schema is portable to machines not supporting save_program/1 and
  in general exploits more of dynamic linking and libraries.


XPCE/SICStus Prolog (make target `xpce-sicstus'):
-------------------------------------------------

[ Unfortunately version 4.8.13 is not updated for SICStus Prolog.  It
  will *not* to run without modifications.  Our SICStus market
  is very small, so please contact me if you have troubles/plans.
]

Either first install using SWI-Prolog, or configure using:

	% ./configure --without-pl

edit the Makefile to fix the definition of:

	# SICSHOME
	Absolute path to the installation directory of SICS Prolog
	(Version 2.1#9 or later).

	# SICSTARGET
	Place where the binary should be dumped

Compilation:
============

* After editing Makefile, give the following command to create the
  XPCE/SWI-Prolog target:
  
	% make clean; make

  where `make' MUST BE GNU-MAKE!!!!

  This is what the *start* of the compilation should look like
  (on a SUN sparc workstation running SunOs 4.1.3, using gcc
  2.6.3 and gnu-make 3.74):

  ================================================================
  swisun31 (sunos) 7_> make
  ****************
  Making XPCE 4.8.13, Sep 1995 for sparc-sunos4.1.3
  ****************
  mkdir bin
  mkdir lib
  ln -s ../src/h .
  if [ ! -d ../src/names ]; then mkdir ../src/names; fi
  if [ ! -d names ]; then ln -s ../src/names .; fi
  gcc  -O2 -I. -I../src -fPIC -funsigned-char -DHAVE_CONFIG_H -o Names.Gen ../src/Names.Gen.c
  gcc  -O2 -I. -I../src -fPIC -funsigned-char -DHAVE_CONFIG_H -o Names.X ../src/Names.X.c
  ../src/FN -a ../src/h/*.h ../src/???/*.c
  gcc -c  -O2 -I. -I../src -fPIC -funsigned-char -DHAVE_CONFIG_H ../src/adt/area.c -o area.o
  ar: creating libXPCE.a
  gcc -c  -O2 -I. -I../src -fPIC -funsigned-char -DHAVE_CONFIG_H ../src/adt/atable.c -o atable.o
  gcc -c  -O2 -I. -I../src -fPIC -funsigned-char -DHAVE_CONFIG_H ../src/adt/attribute.c -o attribute.o
  ================================================================

* If you just want libXPCE.a, use the target `make xpce' instead of just
  `make', which is equivalent to `make xpce-pl'.  NOTE: if you ran configure
  with the option `--without-pl', the default target is just `xpce'.

* If you want XPCE connected to SICStus Prolog, you need SICStus Prolog
  version 2.1#9 (tested) or later.  Edit the Makefile variables
  SICSHOME and type

	% make xpce-sicstus

* NEVER run make in one of the subdirectories; the toplevel make exports
  necessary context to the sub-makes.

* To REBUILD ALL, you need the utilities `mkproto' and `etags'.  If you
  don't have mkproto (for generating the proto.h files), you can ftp
  this public domain utility from

	ftp://swi.psy.uva.nl/pub/xpce/mkproto.tgz.

  etags is the GNU-Emacs tag-generation program distributed with
  GNU-Emacs and available from many ftp-sites.

  If you have these programs, you can do:

	% make distclean
	% make


Public Installation 
===================

There are two install-options to install the XPCE files with SWI-Prolog.
The first option only copies the runtime  files, while the second option
compies the entire development environment.   To install the DEVELOPMENT
environment, now type:

	make dv-install

To just build the runtime environment, type:

	make rt-install

Overview of the compilation process
===================================

To help you understand where to look if  anything goes wrong, below is a
short overview of the compilation process:

    libXPCE.a
    ---------

	1) Build a table for C-code used XPCE atoms.  This compiles
	Names.Gen.c and Names.X.c and next runs the shell-script src/FN
	to create a database in the directory `src/names' and C-files in
	`src/h/names.ic' and `src/h/names.ih'.

	2) Compiles the files for libXPCE.a and puts them in the library.
	This uses GNU-extensions to make and is one of the reasons why you
	need GNU-make.

	3) a change of XPCE.a is detected and ranlib(1) is ran if XPCE.a
	has changed and ranlib is detected by configure

    XPCE/SWI-Prolog
    ---------------

        * Shared Library Version 

	1) make is fired in pl/src using the target `soall'

	2) This make creates shitf.o, the interface object. This object
	is very similar to the normal interface, but contains the
	functions install() and uninstall() rather than using the link.c
	stub to make the entry-point known.

	3) ld is used to create xpce4pl.so

	4) ../$(PLARCH) is created to hold xpce4pl.so and pl-crt0.o

	5) The SWI-Prolog installation directory is modified.  plrc
	is copied to this directory and a link named `xpce' is made
	from SWI-Prolog's home directory to XPCE.
	
	6) The new system is ran to create .qlf files for various
	XPCE libraries.

	* Statically linked version

	1) make is fired in pl/src to create interface.o and link.o.  The
	first is the interface and the second a table to register the
	interface as Prolog predicates.

	2) Next, $(CC) is used to link $(PLBASE)/runtime/$(PLARCH)/pl.o
	with the created .o files, src/XPCE.a and the necessary Unix
	libraries to create pl/src/xpce.base; the basic Unix executable.

	3) For C++, `mangle' is make'ed from mangle.c and the symbols
	mentioned in pl/src/mlist are changed in xpce.base to some
	unique meaningless name.

	4) Next, xpce -O -g pce_welcome -b $(PLHOME)/boot/init.pl -c
	load.pl is started to create the xpce.qlf boot image.


    XPCE/SICStus Prolog
    -------------------

	This installation process is very similar to XPCE/SWI-Prolog.

Problems:
=========

* If anything goes wrong while building XPCE.a:

	- Check the paths: PCEHOME, XBASE, ARCH

	- Are you running the proper programs:
	
		% make -v
		GNU Make version 3.71, by Richard Stallman and Roland McGrath.
		...
		% gcc -v
		Reading specs from
		/usr/local/lib/gcc-lib/sparc-sun-sunos4.1/2.5.8/specs
		gcc version 2.5.8

	- Any local overrules of include files, libraries, shell utilities?
	  XPCE should build using both native Unix and GNU-Project utilities,
	  except for make and (g)cc that should be the GNU versions.


