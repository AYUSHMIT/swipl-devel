<!DOCTYPE html>
<!--
This is the test file for SWI-Prolog WebAssembly build.
It must be served through a web server. The web server
must use correct MIME type for wasm files.
Such simple-to-use web server is http-server:
<https://www.npmjs.com/package/http-server>
Install using npm i -g http-server
Run http-server command in the swipl-devel
directory and browse to <http://localhost:8080/src/wasm/test.html>
-->
<html>
    <head>
        <meta charset="UTF-8">
        <title>SWI-Prolog WebAssembly build test</title>
    </head>
    <body>
        <style>
	   span.stderr { color: red; }
	   span.query  { font-weight: bold; }
           #query { width: 90%; }
	</style>
	<pre id="output"></pre>
	<form class="input" id="input">
	  <span>?- </span><input type="text" name="query" id="query">
	</form>
        <script src="/build.wasm/src/swipl-web.js"></script>
        <script>
	    let output = document.getElementById('output');
	    let input  = document.getElementById('input');
            let stdin = '';
            let stdinPosition = 0;

            // We use this to provide data into
            // the SWI stdin.
            const setStdin = (string) => {
                stdin = string;
                stdinPosition = 0;
            };
            const readStdin = () => {
                if (stdinPosition >= stdin.length) {
                    return null;
                } else {
                    const code = stdin.charCodeAt(stdinPosition);
                    stdinPosition++;
                    return code;
                }
            };

	    function print_line(line, cls) {
                const node = document.createElement('span');
                node.className = cls;
                node.textContent = line + '\n';
                output.appendChild(node);
            };

	    function pl(s) {
	       Module.prolog.call_string(s);
	    }

	    function query(query) {
		if ( ! /\.\s*/.test(query) )
		    query += ".\n";
	        print_line(`?- ${query}`, 'query');
	        setStdin(query);
		pl('break');
	    }

            input.addEventListener('submit', (e) => {
                e.preventDefault();
                query(e.target.elements.query.value);
                e.target.elements.query.value = '';
            }, false);

	    function bindStdin(module) {
		module.FS.init(readStdin);
	    }

	    var Module = {
                noInitialRun: true,
                arguments: [],
                locateFile: function(file) {
                    return '/build.wasm/src/' + file;
                },
		print:    (line) => print_line(line, 'stdout'),
		printErr: (line) => print_line(line, 'stderr'),
		preRun:   [() => bindStdin(Module)]
            };

            SWIPL(Module).then((module) => {
                pl("format('SWI-Prolog WebAssembly ready!~n')");
            });
        </script>
    </body>
</html>
